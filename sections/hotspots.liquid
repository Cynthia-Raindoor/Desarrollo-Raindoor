{% schema %}
{
  "name": "Hotspots Products",
  "settings": [
    {
      "type": "richtext",
      "id": "header",
      "label": "Titulo"
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "Background Image"
    },
    {
      "type": "color",
      "id": "hotspot_color",
      "label": "Hotspot Color",
      "default": "#ff04ac"
    }
  ],
  "blocks": [
    {
      "type": "hotspot",
      "name": "hotspot Product",
      "settings": [
        {
          "type": "product",
          "id": "selected_product",
          "label": "Product"
        },
        {
          "type": "range",
          "id": "position_x",
          "min": 0,
          "max": 100,
          "step": 1,
          "unit": "%",
          "label": "Position X",
          "default": 50
        },
        {
          "type": "range",
          "id": "position_y",
          "min": 0,
          "max": 100,
          "step": 1,
          "unit": "%",
          "label": "Position Y",
          "default": 50
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Hotspots Products"
    }
  ]
}
{% endschema %}

<style>
  /* ==== BASE (DESKTOP) ==== */
  #shopify-section-{{ section.id }} .hotspot-section {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
    max-width: 1200px;
    margin: 0 auto;
    align-items: start;
  }

  #shopify-section-{{ section.id }} .hotspot-container {
    position: relative;
    grid-column: 2 / 1;
  }

  #shopify-section-{{ section.id }} .hotspot-image {
    width: 100%;
    height: auto;
    display: block;
  }

  #shopify-section-{{ section.id }} .hotspot-products-section {
    grid-column: 2 / 2;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    height: 100%;
    justify-content: center;
    position: relative;
  }

  #shopify-section-{{ section.id }} .hotspot-marker {
    position: absolute;
    width: 40px;
    height: 40px;
    transform: translate(-50%, -50%);
    cursor: pointer;
    z-index: 2;
  }

  #shopify-section-{{ section.id }} .hotspot-icon {
    background: {{ section.settings.hotspot_color }};
    border-radius: 50%;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    transition: transform 0.2s ease;
  }

  #shopify-section-{{ section.id }} .wave-effect {
    position: absolute;
    border-radius: 50%;
    background: {{ section.settings.hotspot_color }};
    opacity: 0.3;
    width: 100%;
    height: 100%;
    animation: wave 0.6s ease-out;
  }

  @keyframes wave {
    0% { transform: scale(1); opacity: 0.3; }
    100% { transform: scale(1.8); opacity: 0; }
  }

  #shopify-section-{{ section.id }} .hotspot-select-product {
    display: none;
    flex-direction: column;
    padding: 1rem;
    text-align: center;
    align-items: center;
    position: absolute;
    width: 100%;
    max-width: 400px;
    top: 0;
    left: 0;
  }

  #shopify-section-{{ section.id }} .hotspot-select-product.active {
    display: flex;
    position: relative;
  }

  #shopify-section-{{ section.id }} .product-image-wrapper {
    position: relative;
    overflow: hidden;
    margin-bottom: 1rem;
  }

  #shopify-section-{{ section.id }} .product-image-wrapper img {
    width: 100%;
    height: auto;
    display: block;
    transition: opacity 0.4s ease;
  }

  #shopify-section-{{ section.id }} .product-image.hover {
    position: absolute;
    top: 0;
    left: 0;
    opacity: 0;
  }

  #shopify-section-{{ section.id }} .hotspot-select-product.active:hover .product-image.hover {
    opacity: 1;
  }

  #shopify-section-{{ section.id }} .hotspot-select-product.active:hover .product-image.main {
    opacity: 0;
  }

  #shopify-section-{{ section.id }} .plp-swatches-wrapper {
    position: static;
    opacity: 1;
    visibility: visible;
    background: transparent;
    padding: 0;
    margin: 1rem 0;
  }

  #shopify-section-{{ section.id }} .card-wrapper {
    min-width: 315px;
    max-width: 315px;
    margin: 0 auto;
  }

  #shopify-section-{{ section.id }} .plp-swatches {
    overflow-x: auto !important;
    overflow-y: hidden !important;
    scrollbar-width: thin !important;
    scrollbar-color: rgba(0, 0, 0, 0.3) transparent !important;
    padding-bottom: 8px !important;
    justify-content: center !important;
  }

  #shopify-section-{{ section.id }} .plp-swatches::-webkit-scrollbar {
    height: 4px !important;
  }

  #shopify-section-{{ section.id }} .plp-swatches::-webkit-scrollbar-track {
    background: transparent !important;
  }

  #shopify-section-{{ section.id }} .plp-swatches::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.3) !important;
    border-radius: 2px !important;
  }



  .hotspot-products-section h3 {
    margin: 1rem 0 0 0;
  }

  /* ==== MOBILE ==== */
  @media (max-width: 768px) {
    #shopify-section-{{ section.id }} .hotspot-section {
      grid-template-columns: 1fr;
      gap: 1.5rem;
      padding: 1rem;
    }

    #shopify-section-{{ section.id }} .hotspot-container {
      grid-column: 1 / -1;
      order: 1;
    }

    #shopify-section-{{ section.id }} .hotspot-products-section {
      grid-column: 1 / -1;
      order: 2;
    }

    /* Imagen centrada al alto */
    #shopify-section-{{ section.id }} .product-image-wrapper {
      height: 280px;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      background: white;
    }

    #shopify-section-{{ section.id }} .product-image-wrapper img {
      height: 100%;
      width: auto;
      max-width: 100%;
      object-fit: contain;
    }





    #shopify-section-{{ section.id }} .hotspot-icon {
      width: 90%;
      height: 90%;
    }

    #shopify-section-{{ section.id }} .text-cantainer {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction:column;
      gap: 0.5rem;
    }

    #shopify-section-{{ section.id }} .card-wrapper {
      min-width: 50%;
      max-width: 50%;
    }

    #shopify-section-{{ section.id }} .plp-swatches {
      justify-content: flex-start !important;
      padding-left: 5px !important;
    }
  }
</style>

{% if section.settings.header != blank %}
  <div class="page-width text-center">
    <h2>{{ section.settings.header }}</h2>
  </div>
{% endif %}

<div class="hotspot-section page-width">
  {% if section.settings.background_image %}
    <div class="hotspot-container">
      {{
        section.settings.background_image
        | image_url: width: 1000
        | image_tag: class: 'hotspot-image', loading: 'lazy', sizes: '100vw'
      }}

      {% for block in section.blocks %}
        {% if block.settings.selected_product %}
          <div
            class="hotspot-marker"
            data-index="{{ forloop.index0 }}"
            style="left: {{ block.settings.position_x }}%; top: {{ block.settings.position_y }}%;"
          >
            <div class="hotspot-icon">
              {% render 'svg-cart' %}
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}

  <div class="hotspot-products-section">
    {% for block in section.blocks %}
      {% if block.settings.selected_product %}
        {% assign product = all_products[block.settings.selected_product] %}
        <div
          class="hotspot-select-product"
          data-index="{{ forloop.index0 }}"
        >
          <!-- IMAGEN -->
          {% if product.images.size > 0 %}
            <div class="product-image-wrapper">
              {{ product.images[0] | image_url: width: 800 | image_tag: class: 'product-image main', loading: 'lazy' }}
              {% if product.images.size > 1 %}
                {{
                  product.images[1]
                  | image_url: width: 800
                  | image_tag: class: 'product-image hover', loading: 'lazy'
                }}
              {% endif %}
            </div>
          {% else %}
            <img src="https://http.cat/images/404.jpg" alt="Sin imagen" style="width:100%; height:auto;">
          {% endif %}

          <!-- INFO -->
          <div style="width: 100%;">
            <div class="text-cantainer">
              <h3 class="product-title">{{ product.title }}</h3>
              <div class="product-price">{{ product.price | money }}</div>
            </div>

            <!-- VARIANTS -->
            <div class="card-wrapper">
              {% render 'plp-add-to-cart', card_product: product %}
              {% render 'plp-add-button', card_product: product %}
            </div>
          </div>
        </div>
      {% endif %}
    {% endfor %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const hotspots = document.querySelectorAll('.hotspot-marker');
    const products = document.querySelectorAll('.hotspot-select-product');
    const addToCartForms = document.querySelectorAll('.plp-add-form');

    let isMobile = window.innerWidth <= 768;
    window.addEventListener('resize', () => {
      isMobile = window.innerWidth <= 768;
    });

    function createWaveEffect(hotspot) {
      if (!isMobile) {
        const wave = document.createElement('div');
        wave.className = 'wave-effect';
        hotspot.querySelector('.hotspot-icon').appendChild(wave);
        wave.addEventListener('animationend', () => wave.remove());
      }
    }

    function showProduct(index) {
      products.forEach((p) => {
        p.classList.remove('active');
        p.style.display = 'none';
      });
      const product = products[index];
      if (product) {
        product.style.display = 'flex';
        product.classList.add('active');
      }
    }

    hotspots.forEach((hotspot, i) => {
      hotspot.addEventListener('click', () => {
        createWaveEffect(hotspot);
        showProduct(i);
      });
    });

    const hotspotIcons = document.querySelectorAll('.hotspot-icon');
    const productsSection = document.querySelector('.hotspot-products-section');
function smoothScrollTo(element, duration = 700) {
  const start = window.scrollY;
  const target = element.getBoundingClientRect().top + start;
  const startTime = performance.now();

  function animate(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    // Easing tipo easeInOutQuad
    const ease = progress < 0.5
      ? 2 * progress * progress
      : -1 + (4 - 2 * progress) * progress;
    window.scrollTo(0, start + (target - start) * ease);
    if (elapsed < duration) requestAnimationFrame(animate);
  }

  requestAnimationFrame(animate);
}

    if (productsSection) {
      hotspotIcons.forEach((icon) => {
        icon.addEventListener('click', function (e) {
          // No detenemos el evento para que el resto (wave, producto) siga funcionando
         smoothScrollTo(productsSection, 800);

        });
      });
    }



    addToCartForms.forEach((form) => {
      form.addEventListener('submit', function (e) {
        e.preventDefault();
        const btn = this.querySelector('.plp-add-btn');
        const original = btn.textContent;
        btn.textContent = 'Añadiando...';
        btn.disabled = true;

        fetch('/cart/add.js', { method: 'POST', body: new FormData(this) })
          .then((r) => r.json())
          .then(() => {
            btn.textContent = '¡Agregado!';
            fetch('/?section_id=cart-drawer')
              .then((r) => r.text())
              .then((html) => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newDrawer = doc.querySelector('.drawer__inner');
                const current = document.querySelector('cart-drawer .drawer__inner');
                if (newDrawer && current) current.innerHTML = newDrawer.innerHTML;
                const drawer = document.querySelector('cart-drawer');
                if (drawer) drawer.open();
              });
            fetch('/cart.js')
              .then((r) => r.json())
              .then((cart) => {
                const count = document.querySelector('.cart-count');
                if (count) count.textContent = cart.item_count;
              });
            setTimeout(() => {
              btn.textContent = original;
              btn.disabled = false;
            }, 2000);
          })
          .catch(() => {
            btn.textContent = 'Error';
            setTimeout(() => {
              btn.textContent = original;
              btn.disabled = false;
            }, 2000);
          });
      });
    });

    // Mostrar el primero en desktop
    if (products.length > 0) {
      showProduct(0);
    }
  });
</script>
 
<script src="{{ 'custom-swatch-plp.js' | asset_url }}" defer></script>
